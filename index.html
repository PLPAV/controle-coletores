<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Controle de Coletores — 72 × 16</title>
<style>
  :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  body { margin:0; background:#f4f4f8; color:#111; padding:18px; }
  h1 { margin:0 0 12px; font-size:18px; }

  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  .pill { background:#eef0f7; border:1px solid #dfe3f1; padding:6px 10px; border-radius:999px; font-size:13px; }

  .box { background:#fff; border:1px solid #e7e7ee; border-radius:12px; padding:12px; margin:12px 0; box-shadow:0 1px 1px rgba(0,0,0,.03); }
  .grid { display:grid; grid-template-columns:1fr; gap:12px; }
  @media (min-width: 980px){ .grid { grid-template-columns:1fr 1fr; } }

  h2 { margin:0 0 8px; font-size:15px; }

  table { width:100%; border-collapse: collapse; font-size:13px; }
  th, td { border-bottom:1px solid #efeff6; padding:7px 6px; text-align:left; vertical-align: top; }
  th { font-size:12px; background:#fafafa; }

  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }

  .kpis { display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:10px; }
  @media (min-width: 980px){ .kpis { grid-template-columns: repeat(5, minmax(0,1fr)); } }

  .kpi { border:1px solid #eee; border-radius:12px; padding:10px; background:#fafafa; }
  .kpi .v { font-size:20px; font-weight:700; }
  .kpi .t { font-size:12px; color:#444; }

  select {
    padding:8px 10px;
    border:1px solid #d9d9e6;
    border-radius:10px;
    background:white;
    font-size:13px;
    line-height: 1.2;
    min-width: 120px;
    cursor: pointer;
    position: relative;
    z-index: 5;
  }

  .muted { color:#666; font-size:12px; }
  .controlRow { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-bottom:8px; }
</style>
</head>
<body>

<h1>Controle de Coletores (72 nodes × 16 coletores)</h1>

<div class="row">
  <span class="pill"><b>Atualização:</b> <span id="lastUpdate" class="mono">—</span></span>
  <span class="pill"><b>Total (filtro):</b> <span id="total" class="mono">0</span></span>

  <span class="pill">
    <b>Filtro de vento:</b>
    <select id="windFilter">
      <option value="ALL">Todos</option>
      <option value="0">0%</option>
      <option value="50">50%</option>
      <option value="100">100%</option>
    </select>
  </span>
</div>

<div class="grid">
  <div class="box">
    <h2>Resumo</h2>
    <div class="kpis">
      <div class="kpi"><div class="v" id="kTotal">0</div><div class="t">Ocorrências</div></div>
      <div class="kpi"><div class="v" id="kWasherOnly">0</div><div class="t">Arruela (somente)</div></div>
      <div class="kpi"><div class="v" id="kSensorOnly">0</div><div class="t">Sensor (somente)</div></div>
      <div class="kpi"><div class="v" id="kBoth">0</div><div class="t">Arruela + Sensor</div></div>
      <div class="kpi"><div class="v" id="kFuros">0</div><div class="t">Quantidade de furos</div></div>
    </div>

    <div class="muted" style="margin-top:10px">
      Total de arruelas: <b id="kTotalWashers">0</b> &nbsp;|&nbsp;
      Total de sensores: <b id="kTotalSensors">0</b>
    </div>
  </div>

  <div class="box">
    <h2>Ocorrências por vento</h2>
    <table>
      <thead><tr><th>Vento</th><th>Ocorrências</th><th>%</th></tr></thead>
      <tbody id="byWind"></tbody>
    </table>
  </div>
</div>

<div class="grid">
  <div class="box">
    <div class="controlRow">
      <h2 style="margin:0">Top Nodes (mais ocorrências)</h2>
      <span class="muted">Node:</span>
      <select id="nodeFocusTop">
        <option value="ALL">Todos</option>
      </select>
    </div>

    <table>
      <thead>
        <tr>
          <th>Node</th>
          <th>Ocorrências</th>
          <th>Arruela (somente)</th>
          <th>Sensor (somente)</th>
          <th>Arruela+Sensor</th>
          <th>Furos (#)</th>
          <th>Tamanhos</th>
        </tr>
      </thead>
      <tbody id="topNodes"></tbody>
    </table>
  </div>

  <div class="box">
    <div class="controlRow">
      <h2 style="margin:0">Incidência (Node–Coletor)</h2>
      <span class="muted">Node:</span>
      <select id="nodeFocusPairs">
        <option value="ALL">Todos</option>
      </select>
    </div>

    <table>
      <thead>
        <tr>
          <th>Node</th><th>Coletor</th><th>Ocorrências</th>
          <th>Arruela</th><th>Sensor</th>
          <th>Ventos</th>
          <th>Datas</th>
          <th>Furos (#)</th>
          <th>Tamanhos</th>
        </tr>
      </thead>
      <tbody id="topPairs"></tbody>
    </table>
  </div>
</div>

<div class="grid">
  <div class="box">
    <h2>Incidência pós-ajuste — Sensores reincidentes</h2>
    <table>
      <thead><tr><th>Node</th><th>Coletor</th><th>Ocorrências</th><th>Ventos</th><th>Datas</th></tr></thead>
      <tbody id="postSensorPairs"></tbody>
    </table>
  </div>

  <div class="box">
    <h2>Incidência pós-ajuste — Arruelas reincidentes</h2>
    <table>
      <thead><tr><th>Node</th><th>Coletor</th><th>Ocorrências</th><th>Ventos</th><th>Datas</th></tr></thead>
      <tbody id="postWasherPairs"></tbody>
    </table>
  </div>
</div>

<script>
/* ==========================
   ÁREA QUE VOCÊ EDITA
========================== */
const DATA_ATUALIZACAO = "05/02/2026";

const entradas = [
  "46-4 vento 100%",
  "52-4 vento 100%",
  "58-6 vento 100%",
  "44-6 vento 100%",
  "33-3 vento 100%",
  "53-3(arruela) vento 100%",
  "11-9 vento 100%",
  "3-7 vento 100%",
  "9-10(arruela) vento 100% 04/02/2026",

  "53-7(arruela) vento 50%",
  "45-13(arruela) vento 50%",
  "29-16(arruela) vento 50%",
  "58-4(arruela e sensor) vento 50% 03/02/2026",
  "39-8(arruela) vento 50%",
  "39-8 vento 50%",
  "39-8 vento 50%",
  "39-8 vento 100%(sensor) 05/02/2026",

  "23-7(arruela) 03/02/2026",
  "11-10(arruela) 04/02/2026"
];

const entradasPosAjusteSensor = [
  // Ex.: "58-4 vento 50% 10/02/2026"
];

const entradasPosAjusteArruela = [
  "39-8 vento 100% 05/02/2026"
];

const entradasFurosplaca = [
  "39-8 vento 100% furo 5mm"
];
/* ==========================
   FIM DA ÁREA DE EDIÇÃO
========================== */

document.getElementById("lastUpdate").textContent = DATA_ATUALIZACAO;

/* --------- PARSER (suporta parênteses em qualquer posição) --------- */
function parseEntry(raw, forcedType = null){
  const txt = String(raw).trim();
  if (!txt) return null;

  let wind = 0;
  const mw = txt.match(/vento\s*(0|50|100)\s*%?/i);
  if (mw && mw[1]) wind = Number(mw[1]);

  let date = "";
  const md = txt.match(/\b(\d{1,2}\/\d{1,2}\/\d{4})\b/);
  if (md && md[1]) date = md[1];

  const mbase = txt.match(/^(\d+)\s*-\s*(\d+)/);
  if (!mbase) return null;
  const node = Number(mbase[1]);
  const coletor = Number(mbase[2]);

  let washer = 0, sensor = 0;
  if (forcedType === "sensor") { sensor = 1; }
  else if (forcedType === "arruela") { washer = 1; }
  else {
    const parens = Array.from(txt.matchAll(/\(([^)]+)\)/g)).map(m => (m[1] || "").toLowerCase());
    const joined = parens.join(" | ");
    washer = joined.includes("arruela") ? 1 : 0;
    sensor = joined.includes("sensor") ? 1 : 0;
  }

  const valid =
    Number.isFinite(node) && Number.isFinite(coletor) &&
    node >= 1 && node <= 72 &&
    coletor >= 1 && coletor <= 16 &&
    [0,50,100].includes(wind);

  return valid ? { wind, node, coletor, washer, sensor, date } : null;
}

function flattenAll(list, forcedType=null){
  const out = [];
  for (const r of list){
    const e = parseEntry(r, forcedType);
    if (e) out.push(e);
  }
  return out;
}

/* ===== Agregadores para tabelas ===== */
function aggInit(){ return { count:0, washer:0, sensor:0, both:0, winds:[], dates:[], holesCount:0, holeSizes:[] }; }
function aggAdd(agg, e){
  agg.count++;

  const isWasherOnly = (e.washer === 1 && e.sensor === 0);
  const isSensorOnly = (e.washer === 0 && e.sensor === 1);
  const isBoth = (e.washer === 1 && e.sensor === 1);

  agg.washer += isWasherOnly ? 1 : 0;
  agg.sensor += isSensorOnly ? 1 : 0;
  agg.both += isBoth ? 1 : 0;

  agg.winds.push(e.wind);
  if (e.date) agg.dates.push(e.date);
}

/* ---- Furos: parse com tamanho ---- */
function parseFuro(raw){
  const txt = String(raw).trim();
  if (!txt) return null;

  let wind = 0;
  const mw = txt.match(/vento\s*(0|50|100)\s*%?/i);
  if (mw && mw[1]) wind = Number(mw[1]);

  const mbase = txt.match(/^(\d+)\s*-\s*(\d+)/);
  if (!mbase) return null;
  const node = Number(mbase[1]);
  const coletor = Number(mbase[2]);

  // tamanho: pega "furo 5mm", "furo 4.5 mm", "furo 5 mm", etc.
  let size = "";
  const ms = txt.match(/furo\s*([0-9]+(?:[.,][0-9]+)?)\s*mm/i);
  if (ms && ms[1]) size = (ms[1].replace(",", ".") + "mm");

  const valid =
    Number.isFinite(node) && Number.isFinite(coletor) &&
    node >= 1 && node <= 72 &&
    coletor >= 1 && coletor <= 16 &&
    [0,50,100].includes(wind);

  return valid ? { wind, node, coletor, size } : null;
}

function flattenFuros(list){
  const out = [];
  for (const r of list){
    const e = parseFuro(r);
    if (e) out.push(e);
  }
  return out;
}

/* ---- Mapas de furos por par e por node ---- */
function buildHoleMaps(furos){
  const byPair = new Map(); // "node-coletor" -> {count, sizes[]}
  const byNode = new Map(); // node -> {count, sizes[]}

  for (const f of furos){
    const key = `${f.node}-${f.coletor}`;

    if (!byPair.has(key)) byPair.set(key, { count:0, sizes:[] });
    const p = byPair.get(key);
    p.count++;
    if (f.size) p.sizes.push(f.size);

    if (!byNode.has(f.node)) byNode.set(f.node, { count:0, sizes:[] });
    const n = byNode.get(f.node);
    n.count++;
    if (f.size) n.sizes.push(f.size);
  }

  return { byPair, byNode };
}

function populateNodeSelect(selectEl, nodes, keepValue=true){
  const prev = keepValue ? selectEl.value : "ALL";
  while (selectEl.options.length > 1) selectEl.remove(1);
  for (const n of nodes){
    const opt = document.createElement("option");
    opt.value = String(n);
    opt.textContent = String(n);
    selectEl.appendChild(opt);
  }
  const hasPrev = Array.from(selectEl.options).some(o => o.value === prev);
  selectEl.value = hasPrev ? prev : "ALL";
}

function renderByWind(list){
  const counts = new Map([[0,0],[50,0],[100,0]]);
  for (const e of list) counts.set(e.wind, (counts.get(e.wind)||0)+1);
  const total = list.length || 1;

  const tbody = document.getElementById("byWind");
  tbody.innerHTML = "";
  for (const w of [0,50,100]){
    const c = counts.get(w) || 0;
    const pct = Math.round((c/total)*1000)/10;
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${w}%</td><td><b>${c}</b></td><td>${pct}%</td>`;
    tbody.appendChild(tr);
  }
}

function computeByNode(list){
  const byNode = new Map();
  for (const e of list){
    if (!byNode.has(e.node)) byNode.set(e.node, aggInit());
    aggAdd(byNode.get(e.node), e);
  }
  return Array.from(byNode.entries()).sort((a,b)=>b[1].count-a[1].count);
}

function computeByPair(list){
  const byPair = new Map();
  for (const e of list){
    const k = `${e.node}-${e.coletor}`;
    if (!byPair.has(k)) byPair.set(k, aggInit());
    aggAdd(byPair.get(k), e);
  }
  return Array.from(byPair.entries()).sort((a,b)=>b[1].count-a[1].count);
}

function formatSizes(list){
  if (!list || list.length === 0) return "—";
  // mantém repetição (se quiser único, eu mudo)
  return list.join(", ");
}

function renderTopNodes(entries, focusValue){
  const tbody = document.getElementById("topNodes");
  tbody.innerHTML = "";

  const show = (focusValue === "ALL")
    ? entries.slice(0, 12)
    : entries.filter(([node]) => String(node) === focusValue);

  for (const [node, agg] of show){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${node}</td>
      <td><b>${agg.count}</b></td>
      <td>${agg.washer}</td>
      <td>${agg.sensor}</td>
      <td>${agg.both}</td>
      <td>${agg.holesCount || 0}</td>
      <td class="mono">${formatSizes(agg.holeSizes)}</td>
    `;
    tbody.appendChild(tr);
  }

  if (show.length === 0){
    tbody.innerHTML = `<tr><td colspan="7">Sem dados para o node selecionado.</td></tr>`;
  }
}

function renderPairs(entries, focusValue, tbodyId, mode){
  const tbody = document.getElementById(tbodyId);
  tbody.innerHTML = "";

  const filtered = (focusValue === "ALL")
    ? entries
    : entries.filter(([pair]) => String(pair).startsWith(focusValue + "-"));

  const show = filtered.slice(0, 20);

  for (const [pair, agg] of show){
    const [node, coletor] = pair.split("-");
    const windsSorted = agg.winds.slice().sort((a,b)=>a-b).map(w=>`${w}%`).join(", ");

    const datesSorted = agg.dates.slice().sort((a,b)=>{
      const toKey = (s) => {
        const [d,m,y] = s.split("/").map(Number);
        return (y*10000 + m*100 + d);
      };
      return toKey(a) - toKey(b);
    }).join(", ");

    const tr = document.createElement("tr");
    if (mode === "main"){
      tr.innerHTML = `
        <td>${node}</td><td>${coletor}</td>
        <td><b>${agg.count}</b></td>
        <td>${agg.washer}</td><td>${agg.sensor}</td>
        <td class="mono">${windsSorted || "—"}</td>
        <td class="mono">${datesSorted || "—"}</td>
        <td>${agg.holesCount || 0}</td>
        <td class="mono">${formatSizes(agg.holeSizes)}</td>
      `;
    } else {
      tr.innerHTML = `
        <td>${node}</td><td>${coletor}</td>
        <td><b>${agg.count}</b></td>
        <td class="mono">${windsSorted || "—"}</td>
        <td class="mono">${datesSorted || "—"}</td>
      `;
    }
    tbody.appendChild(tr);
  }

  if (show.length === 0){
    tbody.innerHTML = `<tr><td colspan="${mode==='main' ? 9 : 5}">Sem dados.</td></tr>`;
  }
}

function update(){
  const all = flattenAll(entradas, null);

  const wind = document.getElementById("windFilter").value;
  const filtered = (wind === "ALL") ? all : all.filter(e => e.wind === Number(wind));

  document.getElementById("total").textContent = String(filtered.length);
  document.getElementById("kTotal").textContent = String(filtered.length);

  // RESUMO por coletor (par node–coletor)
  const statusPorPar = new Map(); // key -> {hasWasher, hasSensor}
  for (const e of filtered){
    const key = `${e.node}-${e.coletor}`;
    if (!statusPorPar.has(key)) statusPorPar.set(key, { hasWasher:false, hasSensor:false });
    const st = statusPorPar.get(key);
    if (e.washer) st.hasWasher = true;
    if (e.sensor) st.hasSensor = true;
  }

  let washerOnly=0, sensorOnly=0, both=0;
  for (const st of statusPorPar.values()){
    if (st.hasWasher && st.hasSensor) both++;
    else if (st.hasWasher && !st.hasSensor) washerOnly++;
    else if (!st.hasWasher && st.hasSensor) sensorOnly++;
  }

  document.getElementById("kWasherOnly").textContent = String(washerOnly);
  document.getElementById("kSensorOnly").textContent = String(sensorOnly);
  document.getElementById("kBoth").textContent = String(both);

  document.getElementById("kTotalWashers").textContent = String(washerOnly + both);
  document.getElementById("kTotalSensors").textContent = String(sensorOnly + both);

  // KPI: Quantidade de furos (linhas) no filtro atual
  const furosAll = flattenFuros(entradasFurosplaca);
  const furosFiltered = (wind === "ALL") ? furosAll : furosAll.filter(f => f.wind === Number(wind));
  document.getElementById("kFuros").textContent = String(furosFiltered.length);

  // Mapas de furos (para Top Nodes e Incidência)
  const holeMaps = buildHoleMaps(furosFiltered);

  renderByWind(filtered);

  const nodeList = Array.from(new Set(filtered.map(e => e.node))).sort((a,b)=>a-b);

  const selTop = document.getElementById("nodeFocusTop");
  const selPairs = document.getElementById("nodeFocusPairs");
  populateNodeSelect(selTop, nodeList, true);
  populateNodeSelect(selPairs, nodeList, true);

  // Top Nodes + anexar furos por node
  const byNode = computeByNode(filtered);
  for (const [node, agg] of byNode){
    const h = holeMaps.byNode.get(node);
    agg.holesCount = h ? h.count : 0;
    agg.holeSizes = h ? h.sizes.slice() : [];
  }
  renderTopNodes(byNode, selTop.value);

  // Incidência + anexar furos por par
  const byPair = computeByPair(filtered);
  for (const [pair, agg] of byPair){
    const h = holeMaps.byPair.get(pair);
    agg.holesCount = h ? h.count : 0;
    agg.holeSizes = h ? h.sizes.slice() : [];
  }
  renderPairs(byPair, selPairs.value, "topPairs", "main");

  // Pós-ajuste (sem furos aqui, por enquanto)
  const postSensor = flattenAll(entradasPosAjusteSensor, "sensor");
  const postWasher = flattenAll(entradasPosAjusteArruela, "arruela");
  renderPairs(computeByPair(postSensor), "ALL", "postSensorPairs", "post");
  renderPairs(computeByPair(postWasher), "ALL", "postWasherPairs", "post");
}

document.getElementById("windFilter").addEventListener("change", update);
document.getElementById("nodeFocusTop").addEventListener("change", update);
document.getElementById("nodeFocusPairs").addEventListener("change", update);

update();
</script>

</body>
</html>
